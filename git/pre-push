#!/bin/sh
# pre-push hook - Enhanced with merge restrictions

current_branch=$(git rev-parse --abbrev-ref HEAD)

# Block direct pushes to protected branches
case "$current_branch" in
    main|development)
        echo "âŒ Direct push to $current_branch blocked!"
        echo "âœ… Use Pull Request workflow"
        exit 1
        ;;
esac

# Check if current commit is a merge commit
if git rev-parse --verify -q MERGE_HEAD >/dev/null 2>&1 || \
   git show --pretty=format:"%P" -s HEAD | grep -q " "; then
    
    echo "ğŸ” Merge commit detected"
    
    # Block merges in feature/* and release/* branches
    case "$current_branch" in
        feature/*|release/*)
            echo "âŒ Merge commits not allowed in $current_branch!"
            echo "âœ… Use rebase instead: git rebase <parent-branch>"
            echo "âœ… Or squash commits: git rebase -i HEAD~n"
            exit 1
            ;;
    esac
fi

# Get the branch this was created from - FIXED METHOD
parent=$(git reflog show --format="%gs" HEAD | grep "checkout: moving from" | head -1 | awk '{print $4}')

echo "ğŸ” Debug info:"
echo "  Current branch: $current_branch"
echo "  Detected parent: '$parent'"

# Validate branch pattern and parent
case "$current_branch" in
    hotfix/*)
        if [ "$parent" != "main" ]; then
            echo "âŒ Hotfix must be from main, found: $parent"
            exit 1
        fi
        ;;
    feature/*|release/*)  
        if [ "$parent" != "development" ]; then
            echo "âŒ Feature/Release must be from development, found: $parent"
            exit 1
        fi
        ;;
    *)
        echo "âŒ Invalid branch name: $current_branch"
        echo "âœ… Use: feature/*, hotfix/*, release/*"
        exit 1
        ;;
esac

echo "âœ… Branch validation passed!"